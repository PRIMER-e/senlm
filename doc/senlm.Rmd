---
title: "Using the `senlm` package"
package: senlm
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{senlm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  ##comment = "#>"  
  comment = ""  
)
```

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 100)
```

# Installing the senlm package

```{r installation, eval=FALSE}
install.packages("devtools")
devtools::install_github("PRIMER-e/senlm")
```

# Loading the senlm package

```{r setup}
library(senlm)
```

# Models

The models (mean functions and error distributions) described here are
for non-negative data. If it is possible to simulate negative data
from these models (e.g. Gaussian error) then it is understood that
those data points will be set to zero. Also, if a mean function takes
a negative value, then the mean function should be set to zero at that
location. Any data simulated from a mean function equal to zero, must
be zero.

If the data is Bernoulli or percentage data then the data is bounded
inclusively between 0 and 1.

If the data is binomial count data, then then the data is bounded
inclusively between 0 and $n$.

The parameters for the mean function are stored in $\theta_M$, the 
parameters for the error distribution are stored in $\theta_E$. 
The binomial $n$ value, and the $\delta$ parameter of the tail-adjusted
beta are stored in $\theta_C$.



## Mean functions

The available mean functions can be printed via the 
<tt>mean_function()</tt> function. The mean functions are further 
classified as being of type <tt>test</tt>, <tt>main</tt>, or <tt>sub</tt>.
The <tt>test</tt> class functions are mainly used for testing
code, and the <tt>sub</tt> class functions are special 
cases of the <tt>main</tt> functions.

```{r, echo=FALSE}
knitr::kable(mean_functions())
```

All mean functions have an $H$ parameter determining the maximum 
height of the mean function. The range of this parameter depends on the the 
error distribution (see next section). If the error distribution class is
<tt>binary</tt> or <tt>percentage</tt>, then $H$ is between 0 and 1; 
if the error distribution class <tt>binomial</tt>, then $H$ is between 0 
and $n$; otherwise $H$ must be positive.

The mean functions, $\mu_{\theta_M}(x)$,
are listed below in detail, with parameter descriptions, and their
classification in parentheses in the title. 
The <tt>get_mean_fun_parnames()</tt> output displays the name 
of the parameters used in the package - sometimes the code uses a simpler
roman character rather than a greek spelling e.g. <tt>w</tt> 
for $\omega$ (<tt>omega</tt>).

### <tt>constant</tt> (test)

The constant mean function.

$$
\begin{aligned}
\theta_M &= \{H\} \\
H &= \mbox{Mean response (}H > 0, ~0 < H < 1, ~0 < H < n) \\
\mu_{\theta_M}(x) &= H \\
\end{aligned}
$$

```{r}
get_mean_fun_parnames("constant")
```


### <tt>uniform</tt> (test)

This mean function is uniform between $c$ and $d$, with constant value between $c$ 
and $d$ of $H$, and zero elsewhere.

$$
\begin{aligned}
\theta_M  &= \{H, c, d\} \\
H &= \mbox{Mean response} ~(H > 0 ~~\mbox{or}~~ 0 < H < 1 ~~\mbox{or}~~ 0 < H < n) \\
c &= \mbox{Lower bound} ~(-\infty < c < \infty) \\
d &= \mbox{Upper bound} ~(-\infty < d < \infty, ~c < d) \\
\mu_{\theta_M}(x) &= H \times 1_{[c,d]}(x) \\
&= \left\{ \begin{array}{cl} 0, & x < c \\
            H, & c \leq x \leq d \\
            0, & x > d \\
           \end{array} \right . 
\end{aligned}
$$

```{r}
get_mean_fun_parnames("uniform")
```


### <tt>beta</tt> (main)

This mean curve is a modified version of the p.d.f. of a beta
distribution. A standard beta distribution p.d.f. has the form:

\[ f(x) = \frac{x^{a-1} (1-x)^{b-1}}{B(a,b)}, \]

where $a,b > 0$, $0 \leq x \leq 1$, and $B(a,b)$ is the beta function
(normalising constant). The density curve takes different shapes as
follows: 

| $a$ | $b$ | Shape |
|---:|---:|:---|
| $< 1$ | $~~~< 1$ | $U$-shaped |
| $1$   | $~~~1$   | Uniform    |
| $2$ | $~~~1$   | Triangular (positive)|
| $1$   | $~~~2$ | Triangular (negative) |
| $> 1$ | $~~~< 1$ | $J$-shaped (positive) |
| $< 1$ | $~~~> 1$ | $J$-shaped (negative) |
| $> 1$ | $~~~> 1$ | Unimodal   |

We modify this by translating the $x$-domain from $(0,1)$ to $(c,d)$,
and multiplying by a height parameter $H$. We also transform the $a$
and $b$ parameters to the $u$ and $v$ as follows:

\[ u = \frac{a}{a+b}, ~~~v=\frac{1}{a+b}. \]

Under this parameterisation, $u$ ($0<u<1$) is the mean of the 
beta distribution, and $v$ ($v>0$) is a shape parameter. We restrict
ourselves to functions that are not $U$ or $J$ shaped (i.e $a \geq 1$, 
and $b \geq 1$). 

$$
\begin{aligned}
\theta_M &= \{H, c, d, u, v\} \\
H &= \mbox{Mean response} ~(H > 0 ~~\mbox{or}~~ 0 < H < 1 ~~\mbox{or}~~ 0 < H < n) \\
c &= \mbox{Lower bound} ~(-\infty < c < \infty)  \\
d &= \mbox{Upper bound} ~(-\infty < d < \infty, ~c < d)  \\
u &= \mbox{Mean of the beta distribution} ~(0 < u < 1) \\
v &= \mbox{Shape parameter} ~(v > 0)
~ & ~ \\
\mu_{\theta_M}(x) &= \frac{H}{H_m}\frac{1}{B(a,b)}
\left(\frac{x-c}{d-c}\right)^{a-1}
\left(\frac{d-x}{d-c}\right)^{b-1}
\end{aligned}
$$
where $a=\frac{u}{v}$ and $b=\frac{1-u}{v}$, and $H_m$ is the maximum value of the
beta distribution.

```{r}
get_mean_fun_parnames("beta")
```


### <tt>sech</tt> (main)

This mean function is a modified sech function. The basic sech function has the following form:

\[ \mbox{sech} (x) = \frac{2}{e^x + e^{-x}}. \]

This is a symmetric, unimodal function centered around zero. This
function is modified as follows.

$$
\begin{aligned}
\theta_M &= \{H, m, s, r, p\} \\
H &= \mbox{Mean response} ~(H > 0 ~~\mbox{or}~~ 0 < H < 1 ~~\mbox{or}~~ 0 < H < n) \\
m &= \mbox{Mode} ~(-\infty < m < \infty)  \\
s &= \mbox{Spread parameter} ~(s > \infty)  \\
r &= \mbox{Skewness parameter} ~(-1 < r < 1) \\
p &= \mbox{Peakedness parameter} ~(p > 0)
~ & ~ \\
\mu_{\theta_M}(x) &= \frac{H}{H_m}
\exp\left(\frac{rp}{s}(x - (m-x_m))\right)
\left(\mbox{sech}\left(\frac{x-(m-x_m)}{s}\right)\right)^p
\end{aligned}
$$
where $x_m = \frac{s}{2}\log\left(\frac{1+r}{1-r}\right)$ and 
$H_m = \exp\left(\frac{rp}{s}x_m\right)\left(\sqrt{1 - r^2}\right)^p$
The values $x_m$ and $H_m$ are used to fix the curve so $m$ is the location of
the mode, and $H$ is the maximum height of the curve (at $m$). If $r$ is positive
the curve is positively skewed.

```{r}
get_mean_fun_parnames("sech")
```


### <tt>sech_p1</tt> (sub)

This is the same mean function as <tt>sech</tt> but with $p = 1$.

```{r}
get_mean_fun_parnames("sech_p1")
```


### <tt>sech_r0p1</tt> (sub)

This is the same mean function as <tt>sech</tt> but with $r = 0$, and $p = 1$.

```{r}
get_mean_fun_parnames("sech_r0p1")
```


### <tt>gaussian</tt> (main)

This mean function is a Gaussian curve with a maximum height $H$, located
at mean/mode $m$, and a standard deviation of $s$.

$$
\begin{aligned}
\theta_M  &= \{H, m, s\} \\
H &= \mbox{Maximum value of mean function} ~(H > 0, ~~\mbox{or}~~ 0 < H < 1, ~~\mbox{or}~~ 0 < H < n)  \\
m &= \mbox{Location of maximum of mean function} 
          ~(-\infty < m < \infty)  \\
s &= \mbox{Standard deviation of mean function} ~(s > 0) \\
~ & ~ \\
\mu_{\theta_M}(x) &= H \exp\left(-\frac{1}{2}\left(\frac{x-m}{s}\right)^2\right)
\end{aligned}
$$

```{r}
get_mean_fun_parnames("gaussian")
```


### <tt>mixgaussian</tt> (main)

This mean function is a mixture of two Gaussian curves. The first
component has a maximum height located at mean/mode $m_1$, with
a standard deviation of $s_1$. Similarly the second component has a
maximum height located at mean/mode $m_2$, with a standard
deviation of $s_2$. The mixture probability is given by $\alpha$, and 
the maximum height of the curve is given by $H$.
The condition, $m_1 \leq m_2$, ensures that component one is always on the left.

$$
\begin{aligned}
\theta_M &= \{H, \alpha, m_1, m_2, s_1, s_2\} \\
H &= \mbox{Maximum value of mean function} ~(H > 0, ~~\mbox{or}~~ 0 < H < 1, ~~\mbox{or}~~ 0 < H < n)  \\
\alpha &= \mbox{Mixture probability for first component} ~(0 < \alpha < 1) \\
  m_i &= \mbox{Mean/mode of $i^{th}$ component}
  ~(-\infty < m_i< \infty) \\
  s_i &= \mbox{Standard deviation of $i^{th}$ component} 
   ~(s_i > 0) \\
  ~ & ~ \\
\mu_{\theta_M}(x) &= \frac{H}{H_m}\left\{ \alpha\exp\left(-\frac{1}{2}\left(\frac{x-m_1}{s_1}\right)^2\right) + 
              (1-\alpha)\exp\left(-\frac{1}{2}\left(\frac{x-m_2}{s_2}\right)^2\right)
              \right\}
\end{aligned}
$$

where $H_m$ is the maximum value of the unscaled ($H=1$) gaussian mixture curve.
This is determined numerically.

```{r}
get_mean_fun_parnames("mixgaussian")
```


### <tt>mixgaussian_equal</tt> (sub)

This mean function is a the same as the <tt>mixgaussian</tt> mean function, but
with the constraint that $s_1 = s_2 ~(=s)$.

```{r}
get_mean_fun_parnames("mixgaussian_equal")
```


### <tt>hofV</tt> (main)

This mean function is a scaled product of two sigmoid (logistic) growth curves 
(one increasing and one decreasing). The growth rates of each curve are 
$\omega_1$ and $\omega_2$ , and the points of inflection (half height locations) 
of each curve occur at $m − k$ and $m + k$ respectively.

$$
\begin{aligned}
\theta_M &= \{H, m, \omega_1, \omega_2, k\} \\
H &= \mbox{Maximum value of mean function} ~(H > 0, ~~\mbox{or}~~ 0 < H < 1, ~~\mbox{or}~~ 0 < H < n)  \\
  m &= \mbox{Mid-point between points of inflection} ~(-\infty < m < \infty) \\
  \omega_1 &= \mbox{Growth rate parameter of increasing growth curve}
  ~(\omega_1 > 0) \\
  \omega_2 &= \mbox{Growth rate parameter of decreasing growth curve} 
  ~(\omega_2 > 0) \\
  k &= \mbox{Half the distance between points of inflections} ~(k > 0) \\
  ~ & ~ \\
\mu_{\theta_M}(x) &= \frac{H}{H_m}
\left(\frac{1}{1 + \exp{(-\omega_1(x-(m-k))}}\right)
\left(\frac{1}{1 + \exp{(\omega_2(x-(m+k))}}\right)
\end{aligned}
$$

The variable $H_m$ is the maximum value of the unscaled product of the sigmoidal
functions. The value of $H_m$ is determined numerically.

```{r}
get_mean_fun_parnames("hofV")
```


### <tt>hofII</tt> (sub)

This mean function is a sigmoid (logistic) growth curve with a maximum height 
of $H$, a point of inflection $m$, and a growth rate parameter of $\omega_0$.

$$
\begin{aligned}
\theta_M &= \{H, m, \omega_0\} \\
H &= \mbox{Maximum value of mean function} ~(H > 0, ~~\mbox{or}~~ 0 < H < 1, ~~\mbox{or}~~ 0 < H < n)  \\
  m &= \mbox{Point of inflection} ~(-\infty < m < \infty) \\
  \omega_0 &= \mbox{Growth rate parameter} ~(-\infty < \omega_0 < \infty) 
  ~ & ~ \\
\mu_{\theta_M}(x) &= H\left(\frac{1}{1 + \exp{(-\omega_0(x-m))}}\right)
\end{aligned}
$$

```{r}
get_mean_fun_parnames("hofII")
```


### <tt>hofIV</tt> (sub)

This mean function is a scaled product of two sigmoid (logistic) growth curves 
(one increasing and one decreasing). The growth rates of each curve 
is $\omega$, and points of inflection (half height locations) of each curve occur 
at $m − k$ and $m + k$ respectively.

$$
\begin{aligned}
\theta_M &= \{H, m, \omega, k\} \\
H &= \mbox{Maximum value of mean function} ~(H > 0, ~~\mbox{or}~~ 0 < H < 1, ~~\mbox{or}~~ 0 < H < n)  \\
  m &= \mbox{Mid-point between points of inflection} ~(-\infty < m < \infty) \\
  \omega &= \mbox{Growth rate parameter} ~(\omega > 0) \\
  k &= \mbox{Half the distance between points of inflections} ~(k > 0) \\
  ~ & ~ \\
\mu_{\theta_M}(x) &= \frac{H}{H_m}
\left(\frac{1}{1 + \exp{(-\omega(x-(m-k))}}\right)
\left(\frac{1}{1 + \exp{(\omega(x-(m+k))}}\right)
\end{aligned}
$$

The variable $H_m$ is the maximum value of the unscaled product of the sigmoidal
functions. $H_m = (1 + \exp(−\omega k))^{−2}$.

```{r}
get_mean_fun_parnames("hofIV")
```


### <tt>hofIVb</tt> (sub)

This is the same mean function as the <tt>hofIV</tt>, except that $k = 0$.

$$
\begin{aligned}
\theta_M &= \{H, m, \omega\} \\
H &= \mbox{Maximum value of mean function} ~(H > 0, ~~\mbox{or}~~ 0 < H < 1, ~~\mbox{or}~~ 0 < H < n)  \\
  m &= \mbox{Location of points of inflection} ~(-\infty < m < \infty) \\
  \omega &= \mbox{Growth rate parameter} ~(\omega > 0) \\
  ~ & ~ \\
\mu_{\theta_M}(x) &= \frac{H}{0.25}
\left(\frac{1}{1 + \exp{(-\omega(x-m)}}\right)
\left(\frac{1}{1 + \exp{(\omega(x-m)}}\right)
\end{aligned}
$$

```{r}
get_mean_fun_parnames("hofIVb")
```

### <tt>hofVb</tt> (sub)

This is the same mean function as the <tt>hofV</tt>, except that $k = 0$.

$$
\begin{aligned}
\theta_M &= \{H, m, \omega_1, \omega_2\} \\
H &= \mbox{Maximum value of mean function} ~(H > 0, ~~\mbox{or}~~ 0 < H < 1, ~~\mbox{or}~~ 0 < H < n)  \\
  m &= \mbox{Mid-point between points of inflection} ~(-\infty < m < \infty) \\
  \omega_1 &= \mbox{Growth rate parameter of increasing growth curve}
  ~(\omega_1 > 0) \\
  \omega_2 &= \mbox{Growth rate parameter of decreasing growth curve} 
  ~(\omega_2 > 0) \\
  ~ & ~ \\
\mu_{\theta_M}(x) &= \frac{H}{H_m}
\left(\frac{1}{1 + \exp{(-\omega_1(x-m)}}\right)
\left(\frac{1}{1 + \exp{(\omega_2(x-m)}}\right)
\end{aligned}
$$

```{r}
get_mean_fun_parnames("hofVb")
```


## Error disributions

The error distributions are described in this section. Each error distribution is
classified as to the type of data it is suited for. This information is shown in 
the table below.

```{r, echo=FALSE}
knitr::kable(error_distributions())
```

In the sections that follow, the value of mean function at the $i^{th}$ 
observation $x_i$, is denoted by $\mu_i$. In other words:

\[ \mu_i = \mu_{\theta_M} (x_i). \]


### <tt>bernoulli</tt> (binary)

The Bernouli distribution is used for modelling binary data ($0/1$).
The mean function is bounded between 0 and 1.
There are no extra parameters for this distribution.

$$
\begin{aligned}
y_i &\in \{0, 1\} \\
\theta_E &= \{\} \\
P (Y_i = y_i \mid \theta_M, ~\theta_E , ~x_i) 
&\sim \mbox{Bernoulli}(\mu_i) \\
\end{aligned}
$$

### <tt>binomial_count</tt> (binomial)

The binomial distribution is used for modelling count data that is bounded 
between 0 and $n$. The mean function is bounded between 0 and $n$.
There are no extra parameters for this distribution.

$$
\begin{aligned}
y_i &\in \{0, 1, \ldots, n\} \\
\theta_E &= \{\} \\
\theta_C &= \{n\} \\
P (Y_i = y_i \mid ~\theta_M , ~\theta_C , ~x_i) 
&\sim \mbox{Binomial}(n, ~\mu_i) \\
\end{aligned}
$$
```{r}
get_constant_parnames("binomial_count")
```


### <tt>binomial_prop</tt> (binomial)

This is that same model as the <tt>binomial_count</tt> distribution, except the
data recorded as proportions (counts divided by $n$). 

$$
\begin{aligned}
y_i &\in \{\frac{0}{n}, \frac{1}{n}, \ldots, \frac{n}{n}\} \\
\theta_E &= \{\} \\
\theta_C &= \{n\} \\
P (Y_i = ny_i \mid ~\theta_M , ~\theta_C , ~x_i) 
&\sim \mbox{Binomial}(n, ~\mu_i) \\
\end{aligned}
$$
```{r}
get_constant_parnames("binomial_prop")
```


### <tt>poisson</tt> (count)

The Poisson distribution has mean parameter 
$\lambda=\mu_{\theta_M} (x))$.
There are no extra parameters for this distribution.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\theta_E &= \{\} \\
P (Y_i = y_i \mid \theta_M , ~\theta_E , ~x_i) 
&\sim \mbox{Poisson}(\lambda_i=\mu_i) \\
\end{aligned}
$$


### <tt>negbin</tt> (count)

The negative-binomial distribution we use is actually a Gamma-Poisson distribution with the following form:

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\lambda_i &\sim \mbox{Gamma}(\mbox{shape}=\alpha, ~\mbox{rate}=\beta_i),\\
  P(Y_i=y_i \mid \lambda_i) &\sim \mbox{Poisson}(\lambda_i) \\
  ~ & ~ \\
\mbox{E}(\lambda_i) &= \frac{\alpha}{\beta_i} \\
\mbox{var}(\lambda_i) &= \frac{\alpha}{\beta_i^2}, \\
\mbox{E}(Y_i) &= \frac{\alpha}{\beta_i} + \frac{\alpha}{\beta_i^2} = \mu_i \\
\mbox{var}(Y_i) &= \frac{\alpha}{\beta_i^2} = \mu_i + \frac{\mu_i^2}{\alpha} = \mu_i + \phi \mu_i^2 \\
\end{aligned}
$$
where $\phi = \dfrac{1}{\alpha}$ is the dispersion parameter ($\phi=0$
corresponds to a Poisson distribution), and $\mu_i$ is the mean parameter.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
  \theta_E  &= \{\phi\} \\
  \phi &= \mbox{Dispersion parameter}, ~(\phi > 0) \\
  P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
            &\sim \mbox{Gamma-Poisson}(\mu_i, ~\phi)
\end{aligned}
$$


```{r}
get_err_dist_parnames("negbin")
```


### <tt>zip</tt> (count)

The zero-inflated Poisson (ZIP) distribution has zero-spike parameter $\pi$, 
and mean parameter $\mu_i$.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\theta_E  &= \{\pi\} \\
\pi &= \mbox{Zero-spike parameter}, (0 \leq \pi \leq 1) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
  &\sim \mbox{ZIP}(\mu_i, ~\pi) \\
  &\sim \left\{\begin{array}{ll}
                 \mbox{Poisson}(\mu_i),
                 & \mbox{w.p.} ~~1-\pi, \\
                 0, & \mbox{w.p.} ~~\pi.
               \end{array}\right.
\end{aligned}
$$

```{r}
get_err_dist_parnames("zip")
```

### <tt>zinb</tt> (count)

The zero-inflated negative-binomial (ZINB) distribution has zero-spike 
parameter $\pi$, dispersion parameter $\phi$, and mean parameter $\mu_i$.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\theta_E &= \{\pi, \phi\} \\
\pi &= \mbox{Zero-spike parameter} ~(0 \leq \pi \leq 1) \\
\phi &= \mbox{Dispersion parameter} ~(\phi > 0) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
            &\sim \mbox{ZINB}(\mu_i, ~\pi, ~\phi) \\
            &\sim \left\{\begin{array}{ll}
            \mbox{Gamma-Poisson}(\mu_i, ~\phi),
            & \mbox{w.p.} ~~1-\pi, \\
            0, & \mbox{w.p.} ~~\pi.
           \end{array}\right.
\end{aligned}
$$

```{r}
get_err_dist_parnames("zinb")
```


### <tt>zipl</tt> (count)

The zero-inflated Poisson linked (ZIPL) distribution is a Poisson
distribution with mean parameter $\mu_i$, with a zero spike that has parameters $\gamma_0$ and $\gamma_1$. The zero-spike parameters are linked
to the mean function on the logit/log scale as follows:

\[ \mbox{logit}(\pi_i) = \gamma_0 + \gamma_1\log(\mu_i), \]

where $\pi_i$ is the value of the zero-spike parameter at $x_i$.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\theta_E &= \{\gamma_0, \gamma_1\} \\
\gamma_0 &= \mbox{Zero-spike parameter intercept} 
~(-\infty \leq \gamma_0 \leq \infty) \\
\gamma_1 &= \mbox{Zero-spike parameter slope} 
~(-\infty \leq \gamma_1 \leq \infty) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
            &\sim \mbox{ZIPL}(\mu_i, ~\gamma_0, ~\gamma_1) \\
            &\sim \left\{\begin{array}{ll}
            \mbox{Poisson}(\mu_i),
            & \mbox{w.p.} ~~1-\pi_i, \\
            0, & \mbox{w.p.} ~~\pi_i.
           \end{array}\right.
\end{aligned}
$$

```{r}
get_err_dist_parnames("zipl")
```


### <tt>zinbl</tt> (count)

The zero-inflated negative-binomial linked (ZINBL) distribution is 
a negative-binomial distribution  with mean parameter $\mu_i$, 
dispersion parameter $\phi$, and has zero-spike parameters $\gamma_0$ and
$\gamma_1$. The zero-spike parameters are linked to the mean function on 
the logit/log scale as follows:

\[ \mbox{logit}(\pi_i) = \gamma_0 + \gamma_1\log(\mu_i), \]

where $\pi_i$ is the value of the zero-spike parameter at $x_i$.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\theta_E &= \{\gamma_0, \gamma_1, \phi\} \\
\gamma_0 &= \mbox{Zero-spike parameter intercept} 
~(-\infty \leq \gamma_0 \leq \infty) \\
\gamma_1 &= \mbox{Zero-spike parameter slope} 
~(-\infty \leq \gamma_1 \leq \infty) \\
\phi &= \mbox{Dispersion parameter} ~(\phi > 0) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
            &\sim \mbox{ZINBL}(\mu_i, ~\gamma_0, ~\gamma_1, ~\phi) \\
            &\sim \left\{\begin{array}{ll}
            \mbox{Gamma-Poisson}(\mu_i, ~\phi),
            & \mbox{w.p.} ~~1-\pi_i, \\
            0, & \mbox{w.p.} ~~\pi_i.
           \end{array}\right.
\end{aligned}
$$

```{r}
get_err_dist_parnames("zinbl")
```

### <tt>zipl.mu</tt> (count)

The zero-inflated Poisson linked-$\mu$ (ZIPL$-\mu$) distribution is a Poisson
distribution with mean parameter $\mu_i$, with a zero spike that has parameters $\gamma_0$ and $\gamma_1$. The zero-spike parameters are linked
to the mean function on the logit/linear scale as follows:

\[ \mbox{logit}(\pi_i) = \gamma_0 + \gamma_1\mu_i, \]

where $\pi_i$ is the value of the zero-spike parameter at $x_i$.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\theta_E &= \{\gamma_0, \gamma_1\} \\
\gamma_0 &= \mbox{Zero-spike parameter intercept} 
~(-\infty \leq \gamma_0 \leq \infty) \\
\gamma_1 &= \mbox{Zero-spike parameter slope} 
~(-\infty \leq \gamma_1 \leq \infty) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
            &\sim \mbox{ZIPL-}\mu(\mu_i, ~\gamma_0, ~\gamma_1) \\
            &\sim \left\{\begin{array}{ll}
            \mbox{Poisson}(\mu_i),
            & \mbox{w.p.} ~~1-\pi_i, \\
            0, & \mbox{w.p.} ~~\pi_i.
           \end{array}\right.
\end{aligned}
$$
```{r}
get_err_dist_parnames("zipl.mu")
```

### <tt>zinbl.mu</tt> (count)

The zero-inflated negative-binomial linked-$\mu$ (ZINBL-$\mu$) distribution is 
a negative-binomial distribution  with mean parameter $\mu_i$, 
dispersion parameter $\phi$, and has zero-spike parameters $\gamma_0$ and
$\gamma_1$. The zero-spike parameters are linked to the mean function on 
the logit/linear scale as follows:

\[ \mbox{logit}(\pi_i) = \gamma_0 + \gamma_1\mu_i, \]

where $\pi_i$ is the value of the zero-spike parameter at $x_i$.

$$
\begin{aligned}
y_i &\in \{0, 1, 2, \ldots \} \\
\theta_E &= \{\gamma_0, \gamma_1, \phi\} \\
\gamma_0 &= \mbox{Zero-spike parameter intercept} 
~(-\infty \leq \gamma_0 \leq \infty) \\
\gamma_1 &= \mbox{Zero-spike parameter slope} 
~(-\infty \leq \gamma_1 \leq \infty) \\
\phi &= \mbox{Dispersion parameter} ~(\phi > 0) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
            &\sim \mbox{ZINB-}\mu(\mu_i, ~\gamma_0, ~\gamma_1, ~\phi) \\
            &\sim \left\{\begin{array}{ll}
            \mbox{Gamma-Poisson}(\mu_i, ~\phi),
            & \mbox{w.p.} ~~1-\pi_i, \\
            0, & \mbox{w.p.} ~~\pi_i.
           \end{array}\right.
\end{aligned}
$$
```{r}
get_err_dist_parnames("zinbl.mu")
```


### <tt>gaussian</tt> (abundance)

The Gaussian distribution has mean parameter $\mu_i$ and standard deviation 
$\sigma$.

$$
\begin{aligned}
y_i &\geq 0 \\
\theta_E  &= \{\sigma\} \\
\sigma &= \mbox{Standard deviation} ~(\sigma > 0) \\
P(Y_i=y_i \mid ~\theta_M, ~\theta_E, ~x_i) 
        &\sim \mbox{Normal}(\mu_i, ~\sigma^2)
\end{aligned}
$$
Since our data is non-negative, any data simulated via this model will
have negative values set to zero.

```{r}
get_err_dist_parnames("gaussian")
```


### <tt>tweedie</tt> (abundance)

Tweedie distributions are a class of exponential dispersion models
where the variance is a function of the mean of the form:

\[ \mbox{var}(Y_i) = \phi\mu_i^\rho,\] 

where $\rho \in (-\infty, 0] \cup [1, \infty)$. Special cases include
the normal ($\rho = 0$), Poisson ($\rho = 1$), Gamma ($\rho = 2$) and inverse
Gaussian ($\rho = 3$) distributions. For $1 < \rho < 2$, the distributions
are continuous for $Y > 0$ and have a discrete mass at $Y = 0$. We
will restrict our attention to $1 < \rho < 2$. 

$$
\begin{aligned}
y_i &\geq 0 \\
\theta_E  &= \{\phi, ~\rho\} \\
\phi &= \mbox{Dispersion parameter} ~(\phi > 0) \\
\rho &= \mbox{Power parameter} ~(1 < \rho < 2) \\
P(Y_i=y_i \mid ~\theta_M, ~\theta_E, ~x_i) 
        &\sim \mbox{Tweedie}(\mu_i, ~\phi, ~\rho) \\
\mbox{E}(Y_i) &= \mu_i \\
\mbox{var}(Y_i) &= \phi(\mu_i)^\rho 
\end{aligned}
$$

```{r}
get_err_dist_parnames("tweedie")
```


### <tt>zig</tt> (abundance)

The zero-inflated Gamma (ZIG) distribution has zero-spike parameter
$\pi$, dispersion parameter $\phi$, and mean parameter $\mu_i$.

$$
\begin{aligned}
y_i &\geq 0 \\
\theta_E  &= \{\pi, ~\phi\} \\
\pi &= \mbox{Zero-spike parameter}, ~(0 \leq \pi \leq 1) \\
\phi &= \mbox{Dispersion parameter}, ~(\phi > 0) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
&\sim \mbox{ZIG}(\mu_i, ~\pi, ~\phi) \\
&\sim \left\{\begin{array}{ll}
  \mbox{Gamma}(\mbox{shape}=1/\phi, 
  ~\mbox{scale} = \phi\mu_i)
  & \mbox{w.p.} ~~1-\pi, \\
  0, & \mbox{w.p.} ~~\pi.
  \end{array}\right.\\
\mbox{E}(Y_i) &= (1 - \pi)\mu_i \\
\mbox{var}(Y_i) &= (1-\pi)^2\phi\mu_i^2
\end{aligned}
$$
   

```{r}
get_err_dist_parnames("zig")
```

### <tt>zigl</tt> (abundance)

The zero-inflated gamma linked (ZIGL) distribution is a Gamma
distribution with mean parameter $\mu_i$, a dispersion parameter $\phi$,
and a zero spike that has parameters $\gamma_0$ and $\gamma_1$. 
The zero-spike parameters are linked to the mean function on the 
logit/log scale as follows:

\[ \mbox{logit}(\pi_i) = \gamma_0 + \gamma_1\log(\mu_i), \]

where $\pi_i$ is the value of the zero-spike parameter at $x_i$.

$$
\begin{aligned}
y_i &\geq 0 \\
\theta_E  &= \{\gamma_0, ~\gamma_1, ~\phi\} \\
\gamma_0 &= \mbox{Zero-spike parameter intercept} 
~(-\infty \leq \gamma_0 \leq \infty) \\
\gamma_1 &= \mbox{Zero-spike parameter slope} 
~(-\infty \leq \gamma_1 \leq \infty) \\
\phi &= \mbox{Dispersion parameter}, ~(\phi > 0) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
&\sim \mbox{ZIGL}(\mu_i, ~\gamma_0, ~\gamma_1, ~\phi) \\
&\sim \left\{\begin{array}{ll}
  \mbox{Gamma}(\mbox{shape}=1/\phi, 
  ~\mbox{scale} = \phi\mu_i)
  & \mbox{w.p.} ~~1-\pi_i, \\
  0, & \mbox{w.p.} ~~\pi_i.
  \end{array}\right.\\
\mbox{E}(Y_i) &= (1 - \pi)\mu_i \\
\mbox{var}(Y_i) &= (1-\pi)^2\phi\mu_i^2
\end{aligned}
$$

```{r}
get_err_dist_parnames("zigl")
```


### <tt>zigl.mu</tt> (abundance)

The zero-inflated gamma linked-$\mu$ (ZIGL-$\mu$) distribution is a Gamma
distribution with mean parameter $\mu_i$, a dispersion parameter $\phi$,
and a zero spike that has parameters $\gamma_0$ and $\gamma_1$. 
The zero-spike parameters are linked to the mean function on the 
logit/linear scale as follows:

\[ \mbox{logit}(\pi_i) = \gamma_0 + \gamma_1\mu_i, \]

where $\pi_i$ is the value of the zero-spike parameter at $x_i$.

$$
\begin{aligned}
y_i &\geq 0 \\
\theta_E  &= \{\gamma_0, ~\gamma_1, ~\phi\} \\
\gamma_0 &= \mbox{Zero-spike parameter intercept} 
~(-\infty \leq \gamma_0 \leq \infty) \\
\gamma_1 &= \mbox{Zero-spike parameter slope} 
~(-\infty \leq \gamma_1 \leq \infty) \\
\phi &= \mbox{Dispersion parameter}, ~(\phi > 0) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~x_i) 
&\sim \mbox{ZIGL-}\mu(\mu_i, ~\gamma_0, ~\gamma_1, ~\phi) \\
&\sim \left\{\begin{array}{ll}
  \mbox{Gamma}(\mbox{shape}=1/\phi, 
  ~\mbox{scale} = \phi\mu_i)
  & \mbox{w.p.} ~~1-\pi_i, \\
  0, & \mbox{w.p.} ~~\pi_i.
  \end{array}\right.\\
\mbox{E}(Y_i) &= (1 - \pi)\mu_i \\
\mbox{var}(Y_i) &= (1-\pi)^2\phi\mu_i^2
\end{aligned}
$$

```{r}
get_err_dist_parnames("zigl.mu")
```


### <tt>tab</tt> (percentage)

The tail-adjusted beta (TAB) distribution is a beta distribution where
values less than $\delta$ are rounded down to zero, and values greater
than $1-\delta$ are rounded up to one. This is used to model data that is 
between 0 and 1 (inclusive).

$$
\begin{aligned}
y_i &\in [0,1] \\
\theta_E &= \{\sigma\} \\
\theta_C &= \{\delta\} \\
\sigma &= \mbox{Shape parameter}, (\sigma > 0) \\
\delta &= \mbox{Rounding parameter}, (0 < \delta < \frac{1}{2}) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~\theta_C, ~x_i) 
&\sim \mbox{TAB}(\mu_i, ~\sigma, ~\delta) \\
&\sim \left\{\begin{array}{ll}
p^{(0)}_i & y_i < \delta \\
\dfrac{y_i^{\alpha_i-1}(1-y_i)^{\beta-1}}{B(\alpha,\beta)}
& \delta < y_i < 1 - \delta \\
p^{(1)}_i & y_i > 1 - \delta \\
\end{array}\right.\\
\end{aligned}
$$

where $p^{(0)}_i$ is the probability the Beta($\alpha_i, ~\beta)$
distribution is less than $\delta$, and $p^{(1)}_i$ is the probability
the Beta($\alpha_i, ~\beta)$ distribution is greater than $1 - \delta$.
The parameters of the TAB ($\mu_i$, $\sigma$) are converted to beta distribution
parameters ($\alpha_i$, $\beta$) and back again as follows:
$$
\begin{aligned}
\mu_i &= \dfrac{\alpha_i}{\alpha_i + \beta}, &~
\sigma &= \dfrac{1}{\alpha_i + \beta} \\
\alpha & = \dfrac{\mu_i}{\sigma}, &~ \beta &= \dfrac{1 - \mu_i}{\sigma}
\end{aligned}
$$

We restrict ourselves to $\alpha_i \geq 1$ and $\beta \geq 1$
(uniform, triangular, and unimodal shapes).

The $\delta$ parameter is not estimated via maximum likelihood like other 
parameters, it is estimated as the minimum of: the smallest non-zero $y_i$,
and one minus the largest non-one $y_i$. In other words:
 
\[ \hat{\delta} = \min( \min_i(y_i : y_i>0), ~\min_i(1-y_i : y_i < 1) ). \]


```{r}
get_err_dist_parnames("tab")
get_constant_parnames("tab")
```

### <tt>zitab</tt> (percentage)

The zero-inflated tail-adjusted Beta (ZITAB) distribution is the tail-adjusted beta
distribution with a zero-inflated spike added. 

$$
\begin{aligned}
y_i &\in [0,1] \\
\theta_E &= \{\pi, ~\sigma\} \\
\theta_C &= \{\delta\} \\
\pi &= \mbox{Zero-spike parameter}, ~(0 \leq \pi \leq 1) \\
\sigma &= \mbox{Shape parameter}, (\sigma > 0) \\
\delta &= \mbox{Rounding parameter}, (0 < \delta < \frac{1}{2}) \\
P(Y_i=y_i \mid \theta_M, ~\theta_E, ~\theta_C, ~x_i) 
            &\sim \mbox{ZITAB}(\mu_i, ~\pi, ~\sigma, ~\delta) \\
            &\sim \left\{\begin{array}{ll}
            \pi + (1-\pi)p^{(0)}_i & y_i < \delta \\
            (1-\pi)\dfrac{y_i^{\alpha_i-1}(1-y_i)^{\beta-1}}{B(\alpha,\beta)}
            & \delta < y_i < 1 - \delta \\
            (1-\pi)p^{(1)}_i & y_i > 1 - \delta \\
            \end{array}\right.\\
\end{aligned}
$$

```{r}
get_err_dist_parnames("zitab")
get_constant_parnames("zitab")
```




# Fitting models

## Setting models to fit

The <tt>set_models()</tt> function is used to create a data frame that contains 
the mean functions, error distributions, and if appropriate the binomial $n$ parameter, of all models that one would wish to fit or simulate data from.

```{r}
## All possible combinations of mean functions and error distrbiutions
set_models (mean_fun=c("gaussian", "beta"), err_dist=c("zinb", "zinbl"),
            method="crossed")
## Fit specific models
set_models (mean_fun=c("gaussian", "beta"), err_dist=c("zinb", "zinbl"),
            method="paired")
## Fit binomial model - with n=40
set_models (mean_fun=c("gaussian"), 
            err_dist=c("poisson", "binomial_prop", "binomial_count"),
            binomial_n=40, method="paired")
## Can also specify via mean and error class
set_models (mean_class="main", err_class="percentage")
```



## Simulated data

This section describes how to simulate data sets for any possible model.
The <tt>create_default_par_list()</tt> function set default parameter values for each selected model.

```{r eval=FALSE}
## --- Set models
Models <- set_models (mean_fun=c("gaussian"), err_dist=c("zip", "zinb"))

## --- Set default parameters list
Pars <- create_default_par_list (Models)

## --- Simulate data
Data <- create_simulated_datasets (Pars, N=200, xmin=0, xmax=100, seed=12345)
```

This code creates simulates data for the <tt>gaussian-zip</tt>, and
<tt>gaussian-zinb</tt> models. The objects <tt>Pars</tt> is a list containing 
parameters for each model. The object <tt>Data</tt> is a list containing the data
for each model; <tt>Data[[1]]</tt> is the data for the first model, etc.


## Real data

The <tt>senlm</tt> packages contains the following data sets:

- <tt>haul</tt>

The first few rows of data are shown below.

```{r}
data(haul, package="senlm")
head (haul)
```


## Fitting models to data

To fit one model to a data set we use the <tt>senlm()</tt> function. We illustrate this with the 
<tt>haul</tt> dataset.

```{r}
Fit <- senlm (data=haul, xvar="x_depth", yvar="y_Sebastolobus.altivelis", 
              mean_fun="gaussian", err_dist="zip")
summary (Fit)
```


To fit multiple models to multiple data sets, one can use the <tt>senlm.multi()</tt> function.
The models to fit are specified with the <tt>set_models()</tt> function. The data should be stored in 
a list. It could be simulated data create using the <tt>create_simulated_datasets()</tt> function.

```{r eval=FALSE}
Models <- set_models (mean_class="test", err_class="binary")
Pars   <- create_default_par_list (models=Models)
Data   <- create_simulated_datasets (Pars, seed=12345)
Fits   <- senlm.multi (models=Models, data=Data, xvar="x_depth", yvar="y_Sebastolobus.altivelis")
print (Models)
print (Fits)
```

Alternatively, one can fit multiple models to real data.

```{r eval=FALSE}
Models <- set_models (mean_fun="gaussian", err_dist=c("zip", "zinb"))
Data <- vector (length=2, mode="list")
Data[[1]]$x <- haul$x_depth
Data[[1]]$y <- haul$y_Albatrossia.pectoralis
Data[[2]]$x <- haul$x_depth
Data[[2]]$y <- haul$y_Sebastolobus.altivelis
Fits   <- senlm.multi (Models, Data)
```




# Code organisation












